<!-- cube-members.component.html -->

<!-- Top actions / pending spins (always visible once not loading) -->
<div *ngIf="!loading" class="d-flex justify-content-between align-items-center mb-3">
  <div class="d-flex gap-2 align-items-center">
    <span *ngIf="loserSpinAvailable" class="badge text-bg-warning">
      Loser spin available
    </span>

    <span *ngIf="winnerSpinAvailable" class="badge text-bg-success">
      Winner spin available
    </span>

    <span *ngIf="checkingWheel" class="text-muted small">Checking‚Ä¶</span>
  </div>

  <div class="d-flex gap-2">
    <button
      *ngIf="loserSpinAvailable"
      class="btn btn-sm btn-outline-warning"
      type="button"
      (click)="openLoserSpin()"
      [disabled]="loadingRewardOffer"
    >
      {{ loadingRewardOffer ? 'Loading‚Ä¶' : 'Claim Loser Spin' }}
    </button>

    <button
      *ngIf="winnerSpinAvailable"
      class="btn btn-sm btn-outline-success"
      type="button"
      (click)="openWinnerSpin()"
      [disabled]="claimingWinnerSpin"
    >
      {{ claimingWinnerSpin ? 'Claiming‚Ä¶' : 'Claim Winner Spin' }}
    </button>

    <button
      class="btn btn-sm btn-outline-primary"
      type="button"
      (click)="openClaimLoss()"
      [disabled]="!canClaimLoss()"
    >
      Claim Loss
    </button>
  </div>
</div>

<!-- Claim loss panel -->
<div *ngIf="showingClaimLoss" class="card mb-3">
  <div class="card-body d-flex flex-wrap align-items-center gap-2">
    <div class="fw-semibold me-2">Who won?</div>

    <select
      class="form-select form-select-sm"
      style="width: 220px;"
      [(ngModel)]="selectedWinnerUserId"
      [disabled]="claimingLoss"
    >
      <option [ngValue]="null">Select member‚Ä¶</option>
      <option *ngFor="let w of winnersForDropdown()" [ngValue]="w.userId">
        {{ w.username || ('User #' + w.userId) }}
      </option>
    </select>

    <button
      class="btn btn-sm btn-primary"
      type="button"
      (click)="claimLoss()"
      [disabled]="claimingLoss || !selectedWinnerUserId"
    >
      {{ claimingLoss ? 'Claiming‚Ä¶' : 'Confirm' }}
    </button>

    <button
      class="btn btn-sm btn-outline-secondary"
      type="button"
      (click)="cancelClaimLoss()"
      [disabled]="claimingLoss"
    >
      Cancel
    </button>
  </div>
</div>

<!-- Reward offer panel (winner pick-2, image-only) -->
<div *ngIf="showingRewardOffer" class="card mb-3">
  <div class="card-header d-flex justify-content-between align-items-center">
    <div class="fw-semibold">
      {{ rewardTitle }} ({{ rewardPickedIds.size }}/{{ rewardPickLimit }})
    </div>

    <div class="d-flex gap-2">
      <button
        class="btn btn-sm btn-success"
        type="button"
        (click)="confirmReward()"
        [disabled]="applyingReward || rewardPickedIds.size !== rewardPickLimit"
      >
        {{ applyingReward ? 'Applying‚Ä¶' : 'Confirm Picks' }}
      </button>

      <button
        class="btn btn-sm btn-outline-secondary"
        type="button"
        (click)="closeRewardOffer()"
        [disabled]="applyingReward"
      >
        Close
      </button>
    </div>
  </div>

  <div class="card-body">

    <!-- Loading -->
    <div *ngIf="loadingRewardOffer" class="text-muted small">
      Loading offer‚Ä¶
    </div>

    <!-- Empty -->
    <div *ngIf="!loadingRewardOffer && rewardOfferCards.length === 0"
         class="text-muted small">
      No cards available.
    </div>

    <!-- Main layout -->
    <div *ngIf="!loadingRewardOffer && rewardOfferCards.length > 0"
         class="row g-3">

      <!-- LEFT: image grid -->
      <div class="col-12 col-lg-8">
        <div class="row g-2">

          <div
            class="col-6 col-sm-4 col-md-3 col-lg-2"
            *ngFor="let c of rewardOfferCards"
          >
            <div
              class="position-relative shadow-sm rounded overflow-hidden"
              style="cursor:pointer;"
              (click)="selectRewardDetail(c)"
              [class.border]="isPicked(c.cardId)"
              [class.border-success]="isPicked(c.cardId)"
            >

              <!-- Image -->
              <img
                *ngIf="c.imageUrl"
                [src]="c.imageUrl"
                class="w-100 d-block"
                alt="card"
                style="aspect-ratio: 3 / 4; object-fit: contain;"
              />

              <div
                *ngIf="!c.imageUrl"
                class="d-flex align-items-center justify-content-center text-muted"
                style="aspect-ratio: 3 / 4;"
              >
                No image
              </div>

              <!-- Pick badge -->
              <div
                *ngIf="isPicked(c.cardId)"
                class="position-absolute bottom-0 start-0 m-2 px-2 py-1 rounded text-bg-success small"
              >
                PICKED
              </div>

              <!-- Toggle pick -->
              <button
                type="button"
                class="btn btn-sm position-absolute top-0 start-0 m-2"
                [ngClass]="isPicked(c.cardId) ? 'btn-success' : 'btn-outline-light'"
                (click)="$event.stopPropagation(); togglePick(c.cardId)"
                [disabled]="applyingReward"
                title="Toggle pick"
              >
                {{ isPicked(c.cardId) ? '‚úì' : '+' }}
              </button>

            </div>
          </div>

        </div>
      </div>

      <!-- RIGHT: details panel -->
      <div class="col-12 col-lg-4">

        <div class="card shadow-sm h-100" *ngIf="rewardSelectedDetail">
          <div class="card-body d-flex flex-column">

            <!-- Image -->
            <div class="text-center mb-3">
              <img
                *ngIf="rewardSelectedDetail.imageUrl"
                [src]="rewardSelectedDetail.imageUrl"
                class="img-fluid rounded border"
                alt="card image"
                style="max-height: 420px;"
              />

              <div *ngIf="!rewardSelectedDetail.imageUrl" class="text-muted">
                No image.
              </div>
            </div>

            <!-- Name / Type -->
            <div class="mb-2">
              <div class="fw-semibold">
                {{ rewardSelectedDetail.name ?? ('Card #' + rewardSelectedDetail.cardId) }}
              </div>

              <div class="text-muted small">
                {{
                  rewardSelectedDetail.humanReadableCardType
                  ?? rewardSelectedDetail.cardType
                  ?? ''
                }}
              </div>

              <div
                class="text-muted small"
                *ngIf="rewardSelectedDetail.archetype"
              >
                {{ rewardSelectedDetail.archetype }}
              </div>
            </div>

            <!-- Meta -->
            <div class="mb-2 small text-muted">
              <div>ID: {{ rewardSelectedDetail.cardId }}</div>
            </div>

            <!-- Description -->
            <div
              class="border rounded p-2 small flex-grow-1 mb-3"
              style="overflow-y:auto; background:#fafafa;"
            >
              {{ rewardSelectedDetail.description ?? 'No description.' }}
            </div>

            <!-- Stats -->
            <div
              *ngIf="
                rewardSelectedDetail.atk != null ||
                rewardSelectedDetail.def != null ||
                rewardSelectedDetail.level != null
              "
              class="d-flex justify-content-between align-items-center
                     small text-muted border-top pt-2 mt-2 pb-2"
            >

              <div *ngIf="rewardSelectedDetail.level != null">
                ‚≠ê Level:
                <strong>{{ rewardSelectedDetail.level }}</strong>
              </div>

              <div *ngIf="rewardSelectedDetail.atk != null">
                ‚öîÔ∏è ATK:
                <strong>{{ rewardSelectedDetail.atk }}</strong>
              </div>

              <div *ngIf="rewardSelectedDetail.def != null">
                üõ°Ô∏è DEF:
                <strong>{{ rewardSelectedDetail.def }}</strong>
              </div>

            </div>

            <!-- Pick button -->
            <div class="d-grid gap-2 mt-auto">
              <button
                type="button"
                class="btn btn-sm"
                [ngClass]="
                  isPicked(rewardSelectedDetail.cardId)
                    ? 'btn-success'
                    : 'btn-outline-success'
                "
                (click)="togglePick(rewardSelectedDetail.cardId)"
                [disabled]="applyingReward"
              >
                {{
                  isPicked(rewardSelectedDetail.cardId)
                    ? 'Picked'
                    : 'Pick this card'
                }}
              </button>
            </div>

          </div>
        </div>

      </div>

    </div>
  </div>
</div>

<!-- Errors -->
<div *ngIf="error" class="alert alert-danger py-2 mb-3">
  {{ error }}
</div>

<!-- Loading -->
<div *ngIf="loading" class="text-muted small">
  Loading‚Ä¶
</div>

<!-- Empty state -->
<div *ngIf="!loading && members.length === 0" class="text-muted small">
  No members yet.
</div>

<!-- Members list -->
<div *ngIf="!loading && members.length > 0" class="list-group">
  <div
    class="list-group-item d-flex justify-content-between align-items-center"
    *ngFor="let m of members"
  >
    <!-- Left: identity -->
    <div>
      <div class="fw-semibold">{{ m.username || ('User #' + m.userId) }}</div>
      <div class="text-muted small">Joined {{ m.joinedAt | date:'medium' }}</div>
    </div>

    <!-- Right: controls -->
    <div class="d-flex align-items-center gap-2">

      <!-- Wins badge (click to toggle editor if Admin/Owner) -->
      <span
        class="badge text-bg-dark"
        [class.opacity-75]="!isAdmin()"
        style="cursor: pointer;"
        (click)="toggleWinsEditor(m)"
        title="Wins"
      >
        {{ m.wins }} WINS
      </span>

      <!-- Wins editor (stays open until you click badge again or pick an action) -->
      <div *ngIf="isAdmin() && editingWinsUserId === m.userId" class="btn-group btn-group-sm">
        <button
          class="btn btn-outline-success"
          type="button"
          [disabled]="savingWinsForUserId === m.userId"
          (click)="changeWins(m.userId, 1)"
        >
          +1
        </button>

        <button
          class="btn btn-outline-secondary"
          type="button"
          [disabled]="savingWinsForUserId === m.userId || m.wins <= 0"
          (click)="changeWins(m.userId, -1)"
        >
          -1
        </button>

        <button
          class="btn btn-outline-light"
          type="button"
          [disabled]="savingWinsForUserId === m.userId"
          (click)="closeWinsEditor()"
          title="Close"
        >
          ‚úï
        </button>
      </div>

      <!-- Role badge (clickable if OWNER + not owner row) -->
      <span
        class="badge"
        [class.text-bg-primary]="m.role === 'OWNER'"
        [class.text-bg-secondary]="m.role === 'ADMIN'"
        [class.text-bg-light]="m.role === 'MEMBER'"
        [class.opacity-75]="!(isOwner() && m.role !== 'OWNER')"
        style="cursor: pointer;"
        (click)="toggleRoleEditor(m)"
        title="Role"
      >
        {{ m.role }}
      </span>

      <!-- Inline role editor (only when active) -->
      <select
        *ngIf="isOwner() && editingRoleUserId === m.userId"
        class="form-select form-select-sm"
        style="width: 130px;"
        [disabled]="savingRoleForUserId === m.userId"
        [ngModel]="m.role"
        (ngModelChange)="changeRole(m.userId, $event)"
        (blur)="closeRoleEditor()"
      >
        <option [ngValue]="'MEMBER'">MEMBER</option>
        <option [ngValue]="'ADMIN'">ADMIN</option>
      </select>

      <!-- Remove -->
      <button
        *ngIf="isAdmin() && m.role !== 'OWNER'"
        class="btn btn-sm btn-outline-danger"
        type="button"
        (click)="removeMember(m.userId)"
      >
        Remove
      </button>

    </div>
  </div>
</div>
