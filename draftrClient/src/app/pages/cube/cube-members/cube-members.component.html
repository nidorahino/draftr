<!-- cube-members.component.html -->

<!-- Top actions / pending spins (always visible once not loading) -->
<div *ngIf="!loading" class="d-flex justify-content-between align-items-center mb-3">
  <div class="d-flex gap-2 align-items-center">
    <span *ngIf="loserSpinAvailable" class="badge text-bg-warning">
      Loser spin available
    </span>

    <span *ngIf="winnerSpinAvailable" class="badge text-bg-success">
      Winner spin available
    </span>

    <span *ngIf="checkingWheel" class="text-muted small">Checking…</span>
  </div>

  <div class="d-flex gap-2">
    <button
      *ngIf="loserSpinAvailable"
      class="btn btn-sm btn-outline-warning"
      type="button"
      (click)="openLoserSpin()"
      [disabled]="loadingRewardOffer"
    >
      {{ loadingRewardOffer ? 'Loading…' : 'Claim Loser Spin' }}
    </button>

    <button
      *ngIf="winnerSpinAvailable"
      class="btn btn-sm btn-outline-success"
      type="button"
      (click)="openWinnerSpin()"
      [disabled]="claimingWinnerSpin"
    >
      {{ claimingWinnerSpin ? 'Claiming…' : 'Claim Winner Spin' }}
    </button>

    <button
      class="btn btn-sm btn-outline-primary"
      type="button"
      (click)="openClaimLoss()"
      [disabled]="!canClaimLoss()"
    >
      Claim Loss
    </button>
  </div>
</div>

<!-- Claim loss panel -->
<div *ngIf="showingClaimLoss" class="panel mb-3">
  <div class="panel-body">
    <div class="d-flex flex-wrap align-items-center gap-2">
      <div class="panel-title me-2">Who won?</div>

      <select
        class="form-select form-select-sm claim-select"
        [(ngModel)]="selectedWinnerUserId"
        [disabled]="claimingLoss"
      >
        <option [ngValue]="null">Select member…</option>
        <option *ngFor="let w of winnersForDropdown()" [ngValue]="w.userId">
          {{ w.username || ('User #' + w.userId) }}
        </option>
      </select>

      <button
        class="btn btn-sm btn-primary"
        type="button"
        (click)="claimLoss()"
        [disabled]="claimingLoss || !selectedWinnerUserId"
      >
        {{ claimingLoss ? 'Claiming…' : 'Confirm' }}
      </button>

      <button
        class="btn btn-sm btn-outline-secondary"
        type="button"
        (click)="cancelClaimLoss()"
        [disabled]="claimingLoss"
      >
        Cancel
      </button>
    </div>
  </div>
</div>


<!-- Reward offer panel (winner pick-2 / loser ban) -->
<div *ngIf="showingRewardOffer" class="panel mb-3">
  <div class="panel-head d-flex justify-content-between align-items-center">
    <div class="panel-title">
      {{ rewardTitle }}
      <span class="panel-sub ms-2">({{ rewardPickedIds.size }}/{{ rewardPickLimit }})</span>
    </div>

    <div class="d-flex gap-2">
      <button
        class="btn btn-sm btn-success"
        type="button"
        (click)="confirmReward()"
        [disabled]="applyingReward || !canConfirmReward()"
      >
        {{ applyingReward ? 'Applying…' : 'Confirm' }}
      </button>

      <button
        class="btn btn-sm btn-outline-secondary"
        type="button"
        (click)="closeRewardOffer()"
        [disabled]="applyingReward"
      >
        Close
      </button>
    </div>
  </div>

  <div class="panel-body">
    <!-- Loading -->
    <div *ngIf="loadingRewardOffer" class="text-muted small">
      Loading cards…
    </div>

    <!-- Empty -->
    <div *ngIf="!loadingRewardOffer && rewardOfferCards.length === 0" class="text-muted small">
      No cards in this offer.
    </div>

    <!-- Content -->
    <div *ngIf="!loadingRewardOffer && rewardOfferCards.length > 0" class="row g-3">
      <!-- Left: card grid -->
      <div class="col-12 col-lg-8">
        <div class="row g-2">
          <div class="col-4 col-sm-3 col-md-2" *ngFor="let c of rewardOfferCards">
            <button
              type="button"
              class="btn p-0 w-100 border rounded overflow-hidden position-relative"
              (click)="selectRewardDetail(c)"
              [class.border-primary]="rewardSelectedDetail?.cardId === c.cardId"
              [class.border-2]="rewardSelectedDetail?.cardId === c.cardId"
              [disabled]="applyingReward"
              style="background: transparent;"
              title="{{ c?.name || ('Card #' + c?.cardId) }}"
            >
              <img
                [src]="c?.imageUrl"
                [alt]="c?.name || ('Card #' + c?.cardId)"
                class="img-fluid d-block"
                style="aspect-ratio: 1/1; object-fit: contain; background: rgba(255,255,255,0.04);"
              />

              <!-- Pick toggle -->
              <span
                class="position-absolute bottom-0 end-0 m-1 badge"
                [class.text-bg-success]="isPicked(c.cardId)"
                [class.text-bg-secondary]="!isPicked(c.cardId)"
                (click)="$event.stopPropagation(); togglePick(c.cardId)"
                style="cursor: pointer;"
                title="Pick"
              >
                {{ isPicked(c.cardId) ? 'Picked' : 'Pick' }}
              </span>
            </button>

            <div class="small text-muted mt-1 text-truncate">
              {{ c?.name || ('Card #' + c?.cardId) }}
            </div>
          </div>
        </div>

        <div class="text-muted small mt-2">
          <span *ngIf="rewardMode === 'WINNER_PICK2'">Pick exactly {{ rewardPickLimit }}.</span>
          <span *ngIf="rewardMode === 'LOSER_BAN'">Pick 1 to {{ rewardPickLimit }}. System will ban 1 at random.</span>
        </div>
      </div>

      <!-- Right: details -->
      <div class="col-12 col-lg-4">
        <div class="border rounded p-2">
          <div class="fw-semibold mb-1">
            {{ rewardSelectedDetail?.name || ('Card #' + rewardSelectedDetail?.cardId) }}
          </div>

          <div class="text-muted small mb-2" *ngIf="rewardSelectedDetail?.humanReadableCardType">
            {{ rewardSelectedDetail.humanReadableCardType }}
          </div>

          <img
            *ngIf="rewardSelectedDetail?.imageUrl"
            [src]="rewardSelectedDetail.imageUrl"
            [alt]="rewardSelectedDetail?.name || ('Card #' + rewardSelectedDetail?.cardId)"
            class="img-fluid rounded mb-2"
            style="background: rgba(255,255,255,0.04);"
          />

          <div class="small" *ngIf="rewardSelectedDetail?.description">
            {{ rewardSelectedDetail.description }}
          </div>

          <div class="text-muted small mt-2"
               *ngIf="rewardSelectedDetail?.atk != null || rewardSelectedDetail?.def != null">
            ATK {{ rewardSelectedDetail?.atk ?? '-' }} / DEF {{ rewardSelectedDetail?.def ?? '-' }}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- Add member (Admin/Owner only) -->
<div *ngIf="!loading && !showingRewardOffer && isAdmin()" class="panel mb-3">

  <div class="panel-body">
    <div class="row g-2 align-items-center">
      <!-- Left: title -->
      <div class="col-12 col-lg-4">
        <div class="panel-title">Add member</div>
        <div class="panel-sub">Admin/Owner only</div>
      </div>

      <!-- Right: controls -->
      <div class="col-12 col-lg-8">
        <div class="d-flex flex-wrap justify-content-lg-end gap-2">
          <input
            class="form-control form-control-sm add-input"
            placeholder="Username"
            [(ngModel)]="addUsername"
            (keyup.enter)="addMember()"
          />

          <button
            class="btn btn-sm btn-primary"
            type="button"
            (click)="addMember()"
            [disabled]="!addUsername?.trim()"
          >
            Add
          </button>

          <button
            class="btn btn-sm btn-outline-secondary"
            type="button"
            (click)="addUsername = ''"
            [disabled]="!addUsername"
          >
            Clear
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Errors -->
<div *ngIf="error" class="alert alert-danger py-2 mb-3">
  {{ error }}
</div>

<!-- Spin result banner -->
<div *ngIf="spinResultText" class="alert alert-success py-2 mb-3">
  {{ spinResultText }}
</div>

<!-- Loading -->
<div *ngIf="loading" class="text-muted small">
  Loading…
</div>

<!-- Empty state -->
<div *ngIf="!loading && !showingRewardOffer && members.length === 0" class="text-muted small">

  No members yet.
</div>

<!-- Members list -->
<!-- Members cards -->
<div *ngIf="!loading && !showingRewardOffer && members.length > 0" class="row g-3 members-grid">


<div class="col-12 col-md-6 col-xl-4" *ngFor="let m of members">
  <div class="member-card">

    <!-- TOP -->
    <div class="member-top d-flex justify-content-between align-items-start gap-2">
      <div class="member-id">
        <div class="member-name">
          {{ m.username || ('User #' + m.userId) }}
        </div>
        <div class="member-sub text-muted small">
          Joined {{ m.joinedAt | date:'medium' }}
        </div>
      </div>

      <div class="d-flex align-items-center gap-2 member-role-wrap">
        <span
          class="role-badge"
          [class.role-owner]="m.role === 'OWNER'"
          [class.role-admin]="m.role === 'ADMIN'"
          [class.role-member]="m.role === 'MEMBER'"
          title="Role"
        >
          {{ m.role }}
        </span>

        <ng-container *ngIf="isOwner() && m.role !== 'OWNER'">
          <button
            *ngIf="editingRoleUserId !== m.userId"
            type="button"
            class="btn btn-sm btn-outline-primary role-change-btn"
            (click)="toggleRoleEditor(m)"
            [disabled]="savingRoleForUserId === m.userId"
          >
            Change
          </button>

          <div *ngIf="editingRoleUserId === m.userId" class="d-flex align-items-center gap-2">
            <select
              class="form-select form-select-sm member-role-select"
              [disabled]="savingRoleForUserId === m.userId"
              [ngModel]="m.role"
              (ngModelChange)="changeRole(m.userId, $event)"
            >
              <option [ngValue]="'MEMBER'">MEMBER</option>
              <option [ngValue]="'ADMIN'">ADMIN</option>
            </select>

            <button
              type="button"
              class="btn btn-sm btn-outline-secondary"
              (click)="closeRoleEditor()"
              [disabled]="savingRoleForUserId === m.userId"
              title="Close"
            >
              ✕
            </button>
          </div>
        </ng-container>
      </div>
    </div>

    <!-- META -->
    <div class="member-meta mt-2 d-flex flex-wrap align-items-center gap-2">
      <button
        type="button"
        class="member-wins btn btn-sm"
        [class.btn-outline-light]="!isAdmin()"
        [class.btn-outline-success]="isAdmin()"
        (click)="toggleWinsEditor(m)"
        [disabled]="!isAdmin()"
        title="Wins"
      >
        {{ m.wins }} wins
      </button>

      <div *ngIf="isAdmin() && editingWinsUserId === m.userId" class="btn-group btn-group-sm">
        <button
          class="btn btn-outline-success"
          type="button"
          [disabled]="savingWinsForUserId === m.userId"
          (click)="changeWins(m.userId, 1)"
        >
          +1
        </button>

        <button
          class="btn btn-outline-secondary"
          type="button"
          [disabled]="savingWinsForUserId === m.userId || m.wins <= 0"
          (click)="changeWins(m.userId, -1)"
        >
          -1
        </button>

        <button
          class="btn btn-outline-light"
          type="button"
          [disabled]="savingWinsForUserId === m.userId"
          (click)="closeWinsEditor()"
          title="Close"
        >
          ✕
        </button>
      </div>

      <span class="member-spacer"></span>

      <button
        *ngIf="isAdmin() && m.role !== 'OWNER'"
        class="btn btn-sm btn-outline-danger"
        type="button"
        (click)="removeMember(m.userId)"
      >
        Remove
      </button>
    </div>

    <div class="member-glow"></div>
  </div>
</div>
